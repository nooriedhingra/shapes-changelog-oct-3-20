# Shapes.inc Changelog - October 10-15, 2025

## Block Users in DMs

You can now block users in direct messages.

**How it works:**
- Open DM ‚Üí click header or message menu ‚Üí "Block user"
- Blocked users can't message you
- You can't message blocked users
- One-directional: you blocking them doesn't mean they blocked you
- Unblock anytime from DM header

**What you see:**
- Banner: "You blocked this user" or "This user blocked you"
- Composer disabled with explanation text
- Clear unblock button in header

**Technical details:**
- New table: `user_dm_blocks` with directional blocking
- API route: `/api/dm-blocks` (block, unblock, status check)
- Enforced at DM creation and message send
- Documented in `architecture/user-dm-privacy.md`

**Why:**
Users wanted privacy controls for DMs. Now you can block harassment without reporting.

---

## Session Timeout Fix (Stay Logged In)

Fixed users getting logged out unexpectedly.

**What was broken:**
Auth0 session duration wasn't set in code ‚Äî env vars were being ignored.

**What we fixed:**
- Rolling duration: 100 days (idle time before logout)
- Absolute duration: 365 days (max session life)
- Sessions auto-refresh on any visit

**User impact:**
- Stay inactive for 100 days ‚Üí still logged in
- Active users effectively "logged in forever"
- No more surprise logouts

**Implementation:**
- Explicit session params in all `initAuth0()` calls
- Aligned Auth0 dashboard to match code settings
- Documented in `architecture/AUTH0_SESSION_DURATION_FIX.md`

---

## Starter Message Suggestions

New rooms now show AI-generated conversation starters.

**How it works:**
- Join/create room with no messages from you
- 3 suggestion bubbles appear after Shape greeting
- Click suggestion ‚Üí fills composer (doesn't auto-send)
- Edit before sending
- After first message ‚Üí suggestions disappear

**Smart behavior:**
- Only YOUR message count matters (not others)
- Hides "@mention a shape" hint when suggestions visible
- Cached per room (no duplicate API calls)
- Graceful error handling if API fails

**Why:**
Users stared at empty rooms not knowing what to say. Suggestions kickstart conversation.

**Implementation:**
- Uses existing `/api/messages/suggested-replies`
- 3 parallel fetches per room (session-cached)
- No backend changes needed

---

## Room Directory Improvements

### Removed Upvoting

Removed upvote buttons and vote counts from room directory.

**Before:** Users could upvote rooms, votes determined ranking.
**After:** No voting UI, rooms sorted by activity.

**Why:** Upvotes were gameable and didn't reflect actual room quality. Activity-based ranking is more honest.

### Activity-Based Sorting

Room directory now sorts by latest message time (like homepage recents).

**How it works:**
- SQL subquery gets `MAX(message.createdAt)` per room
- Sort by freshest message timestamp
- Most recently active rooms at top
- Timezone-aware (shows "7 hours ago" not "in 7 hours")

**Technical details:**
- Added `AT TIME ZONE 'UTC'` to timestamp fields
- Removed client-side re-sorting (~70 lines deleted)
- SQL does all sorting before pagination
- Documented in `architecture/room-directory-voting.md`

### Load 100 Rooms at Once

Increased directory page size from 20 ‚Üí 100 rooms per load.

**Why:** Users complained about excessive "Load More" clicking. Now you see way more rooms upfront.

---

## Badge System Overhaul

### Smart Badge Display

Badges now show intelligently based on context.

**In chat messages:**
- Show only TOP 1 badge
- Priority: team > sponsor > room owner > level
- Cleaner message UI, less badge spam

**In profile modal:**
- Show ALL badges (team, sponsor, level, room owner)
- Full badge collection visible

**Your own messages:**
- Now show badges (previously hidden for no reason)

**Implementation:**
- `use-participant-badges.ts`: top badge priority logic
- `profile-modal-content.tsx`: show all badges
- `pill-data-loader.ts`: enriched data with level fields

### Clickable Badges

Badges in chat are now clickable ‚Äî opens user profile modal.

**Why:** Users wondered "who is this team member?" Now click badge ‚Üí see profile.

### Premium Badge

Added "Premium" badge for premium users.

**Shows when:**
- User has active premium subscription
- Displays in profile modal and chat (if top priority)

**Removed badge preferences:**
Deleted old "badge preferences" UI. Too confusing, no longer needed with smart display logic.

---

## Create Room Modal UX Improvements

**Auto-scroll to top on page change**

Modal now scrolls to top when you click Next/Back between pages.

**Before:** You'd be mid-scroll on page 2, click Next, page 3 loads but you're still mid-scroll.
**After:** Page changes ‚Üí instant scroll to top. Clean experience.

**Clickable upload boxes**

Image/icon upload boxes are now fully clickable.

**Before:** Had to click tiny "Upload" text.
**After:** Click anywhere on the picture box ‚Üí file picker opens.

**Fixed ellipsis overflow on page 2**

Long Shape names no longer bleed out of their containers. Proper text truncation with ellipsis.

**Removed duplicate back button**

Create room modal had TWO back buttons (header + footer). Removed footer back button.

**Conditional formatting improvements**

Cleaner spacing and layout on all 3 pages of create room flow.

**Advanced section visibility**

Page 3 now shows "Advanced" section toggle. Keeps advanced settings tucked away unless you want them.

**Persona feature gating**

**Before:** Persona settings shown to all users on page 4.
**After:**
- Roleplay use case ‚Üí persona at top of page 4
- Casual/Smart use case ‚Üí persona hidden entirely

**Why:** Personas only make sense for roleplay. Don't confuse other users.

---

## Persona UI Improvements

**Better form labels and hints**

Updated persona creation form:
- Labels: "MY NAME" and "MY BACKSTORY" (clearer)
- Hint text: helpful examples matching shapes.inc style
- Placeholders: concrete examples (kpop stan, basketball player, etc.)

**Fixed font size inconsistency**

Input and textarea now both use consistent 14px font. No more size mismatch.

**Scrollable persona cards**

Persona management cards:
- Span full profile width
- Scrollable instruction text (thin viewport)
- Single-column layout
- Edit/delete actions inline with default toggle

**Before:** Cards cramped, hard to read long instructions.
**After:** Full-width, clean layout, easy to scan.

**Hidden nav buttons on personas page**

Removed "Chat Now", "Profile", "Copy link" buttons from personas and settings pages. Unnecessary clutter.

---

## Rewards Timer Updates

**Deadline changed to Monday 00:00 UTC**

Weekly rewards deadline moved from Sunday ‚Üí Monday midnight UTC.

**Why:** Aligns with backend week changes (Monday-Sunday weeks).

**+24hr Bonus Banner (One-Time)**

Showed until Oct 13, 2025:

```
üéÅ Bonus! We gave you +24hrs
~~3h 42m left~~ (strikethrough)
1d 3h 42m left! (new deadline)
```

**Psychology:**
- Reciprocity: "We gave you..." creates engagement obligation
- Loss aversion: Shows what you would've lost
- Gain framing: Green banner = positive surprise
- Urgency maintained: Live countdown still ticking

**Banner disappeared after Oct 13.** Feature no longer active.

---

## Moderation Improvements

**UID Search in Moderation Panel**

Super editorial staff can now search users by UID (user ID).

**Before:** Search by email or username only.
**After:** Search by email | username | UID.

**How it works:**
- New API: `/api/users/search-by-uid`
- Updated `/api/moderation/user-chats` to accept `uid` param
- UID search button in Rooms and Users tabs

**Why:** User IDs are permanent, emails/usernames change. UID search never fails.

**Deleted Room Badge in Moderation**

Moderation UI now shows "Deleted" badge for deleted rooms.

**New behavior:**
- Super editorial can view deleted rooms
- Chat page allows deleted room access for staff
- Room info API returns deleted room data for staff

**Implementation:**
- Added `deleted` flag to moderation APIs
- Badge rendering in moderation UI
- Documented in `architecture/MODERATION_AND_BANS.md`

**Filter Globally Banned User Messages**

Messages from globally banned users are now filtered out of chat feeds.

**Before:** Banned users' old messages still visible.
**After:** Messages hidden from non-staff users.

**Note:** Super editorial can still see banned user messages for moderation purposes.

**Deleted User Variant in Ban Modal**

Ban modal now shows "This user is deleted" variant when trying to ban a deleted account.

---

## Chat UX Improvements

**Image Zoom**

Click images in chat ‚Üí full-screen lightbox with zoom.

**How it works:**
- Click image ‚Üí overlay appears
- Pinch/scroll to zoom
- Click outside ‚Üí close
- Works on mobile and desktop

**Implementation:**
- Lightbox component with gesture support
- GPU-accelerated zoom/pan

**Voice Message Playback Fix**

Fixed voice messages stopping when new messages arrived.

**What was broken:**
Audio player would unmount on new message, killing playback.

**Solution:**
- React context tracks active audio players
- New messages don't unmount active players
- Playback continues smoothly

**Note:** This fix was reverted (PR #1830) then re-implemented with better approach (PR #1831).

**Emoji Picker Focus Fix**

Fixed composer stealing focus when you opened emoji picker on mobile.

**Before:** Open emoji picker ‚Üí keyboard pops up (annoying).
**After:** Emoji picker stays in focus, no keyboard interference.

**Implementation:**
- Tagged emoji button and picker with `data-prevent-composer-autofocus`
- Desktop keydown replays skip emoji picker
- Documented in `architecture/MULTIMODAL_INPUT_PERF.md`

**Emoji Autocomplete Dismissal**

Emoji shortcode autocomplete (`:smile:`) now closes after you type space.

**Before:** Type `:smile: ` ‚Üí autocomplete stayed open.
**After:** Space after shortcode ‚Üí autocomplete closes immediately.

**Implementation:**
- Tracks caret position past emoji token
- Re-runs `processEmojiInput` on space
- Clears state and hides panel

**"Copy Message Link" Moved to Bottom**

Message action menu reordered: "Copy Message Link" now at very bottom (after Delete/Report/Kick/Ban).

**Why:** Less frequently used than other actions. Moved to bottom for better menu hierarchy.

**Text Commands Don't Stick**

Typed commands (like `!imagine`) now only apply to current message.

**Before:**
- Type `!imagine cats` ‚Üí sends image generation message
- Next message ALSO had image mode enabled (sticky)

**After:**
- Type `!imagine cats` ‚Üí sends image generation message
- Next message returns to normal text mode

**Button behavior unchanged:**
- Click Image button ‚Üí sticky (stays active for multiple messages)
- Click again to toggle off

**Why:** Typed commands feel like one-time actions. Buttons feel like mode switches. Now behavior matches intent.

**Implementation:**
- Track how mode was enabled (typed vs button)
- Typed commands clear after send
- Button toggles persist
- Documented in `architecture/SHAPES_INC_UI_CHANGES.md`

---

## Settings Reorganization

**Private Account Toggle Moved**

Moved "Private Account" toggle from sidebar dropdown ‚Üí Settings popup.

**Before:** Sidebar user menu ‚Üí scroll down ‚Üí private account toggle (buried).
**After:** Settings icon ‚Üí Privacy section ‚Üí private account toggle (clear).

**Why:** Better discoverability. Privacy settings belong in Settings, not a dropdown.

**Shape Reply Style Toggle (Backend)**

Added database settings for Shape reply style toggle. Frontend UI coming in future PR.

**Configure Shapes Hidden for Non-Owners**

"Configure Shapes" option in room settings now hidden for non-owners.

**Before:** All room members saw "Configure Shapes" (clicking did nothing).
**After:** Only room owners see the option.

**Behavior:**
- User DMs: option hidden (no Shapes to configure)
- Shape DMs: option shown (you're always the owner)
- Multiplayer rooms: owners only

---

## Room Search Improvements

**Search by Username**

Room message search now supports `from:username` syntax.

**How to use:**
- Open room search (magnifying glass icon)
- Type: `from:alice hello` ‚Üí finds "hello" messages from alice
- Type: `project updates` ‚Üí searches all messages

**Implementation:**
- Parses `from:` prefix in search query
- Resolves username ‚Üí user ID via profile cache
- Filters messages by sender
- Documented in `architecture/API_ROUTES_ALPHABETICAL.md`

**Submit-to-Search (Not Live Search)**

Room search now executes on submit, not on every keystroke.

**Before:** Type "hello" ‚Üí 5 API calls (h, he, hel, hell, hello).
**After:** Type "hello" ‚Üí press Enter or click blue arrow ‚Üí 1 API call.

**UX:**
- Blue Enter icon button to submit
- Clear button to reset
- Loading state while searching
- Results persist until next search

**Why:** Reduced API spam, clearer intent, better performance.

---

## Command Palette Fixes (Cmd+K)

**Deduplicated Search Results**

Fixed duplicate rooms appearing in Cmd+K search.

**What was broken:**
Favorited rooms would show twice (once in Favorites, once in Recents/Shape Communities).

**Solution:**
- Shared deduplication helper
- Favorites take priority (show with ‚≠ê badge)
- Duplicates from other categories removed

**Shape Communities Included**

Cmd+K now includes Shape community rooms in search results.

**Before:** Only showed your rooms, DMs, favorites.
**After:** Also shows public Shape communities.

**Documented in `architecture/COMMAND_PALETTE.md`**

---

## Suggested Replies Improvements

**Reduced Suggestions: 3 ‚Üí 1**

New room suggestions reduced from 3 bubbles ‚Üí 1 bubble.

**Why:**
- 3 was too aggressive, felt spammy
- 1 is enough to kickstart conversation
- Reduces API load (1 call instead of 3)

**Fixed Detection Logic**

Fixed starter suggestions showing in rooms with existing user messages.

**Before:** Logic checked `senderId` property (unreliable for old messages).
**After:** Checks for any `role: user` messages.

**Result:** Suggestions only appear in truly empty rooms.

**Wand Icon + Loading Message**

Updated suggestions button:
- Icon: Sparkles ‚ú® ‚Üí Magic Wand ü™Ñ (matches AI features)
- Loading message: "Generating a reply... this may take a few seconds"

**Why:** Sets expectations, provides feedback, matches brand.

**ChatId Parameter Added**

Suggested replies API now accepts `chatId` parameter for context-aware suggestions.

---

## Performance Improvements

**Fixed Batch Voice Status N+1 Queries**

Voice status endpoint was making N queries for N shapes.

**Before:** Fetch 10 shapes ‚Üí 10 separate DB queries.
**After:** Fetch 10 shapes ‚Üí 1 batch query.

**Implementation:**
- Created batch request handler
- Groups shape IDs into single query
- Returns status map

**Impact:** Faster sidebar Shape voice status indicators.

**Fetch Shapes Info on Layout**

Moved Shape info fetching to layout level for better caching.

**Before:** Every page refetched Shape data.
**After:** Layout fetches once, all pages reuse.

---

## Bug Fixes

**Fixed Interaction Modal Bleeding on Directory**

Rare visual bug where interaction modal content would bleed outside bounds. Fixed with proper overflow handling.

**Fixed Instruction Modal Placeholder Bleeding**

Long placeholder text in instruction modals would overflow. Now wraps properly.

**Fixed Forum Page Layout Issues**

Carried over from oct 9 changelog (implemented oct 10).

**Auto-Redirect from Join Page**

If you're already in a room, `/r/[slug]/join` now auto-redirects to `/chat/[id]`.

**Before:** Already a participant ‚Üí still saw join form (confusing).
**After:** Already in ‚Üí instant redirect to chat.

**Fixed Rewards Level Display**

Fixed visual bug in rewards modal showing wrong level badges.

**Fixed Strikethrough Time Display**

Bonus rewards banner: strikethrough time now shows "0h 0m" when old deadline passed (instead of negative time).

---

## Settings UX Polish

**Web and Image Buttons Hidden in User DMs**

Composer toolbar in user DMs no longer shows:
- Web search button
- Image generation button

**Why:** These features don't work in DMs (backend doesn't support it). No point showing buttons that don't work.

**Implementation:**
- Gated button render with `chatType !== 'user_dm'`
- Preserved behavior in all other chat types

**Room Skills Auto-Save + Loading State**

Room skills toggle now:
- Auto-saves on toggle (no Save button needed)
- Shows loading spinner during save
- Toast confirms success

**Note:** This partially reverts the "stage then save" workflow from oct 9. Auto-save is back for skills toggle specifically.

---

**Fixed Custom Section Search**

Sidebar custom sections (like "Favorites") now properly filter rooms when you search.

**Before:** Search in custom section ‚Üí showed all rooms.
**After:** Search filters within that section only.

---

*Shipped by the team at [shapes.inc](http://shapes.inc). Feedback? Drop it in [Forums](/forums) or DM [@shapes](https://talk.shapes.inc/u/shapes/dm)!*