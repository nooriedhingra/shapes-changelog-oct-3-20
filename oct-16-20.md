# Shapes.inc Changelog - October 16-20, 2025

## Locked Rooms

Room owners can now lock rooms to prevent new members from joining.

**How it works:**
- Room settings → "Lock Room" toggle
- Locked rooms block:
  - New join requests
  - New invites
  - Public discovery (hidden from directory)
- Existing members stay in room
- Only room owner can lock/unlock

**What users see:**
- Join page: "This room is locked. New members cannot join at this time."
- Invite attempts fail with error message
- Moderation UI shows "Locked" badge

**Technical details:**
- New column: `is_locked` on `chats` table
- Migration: `20251013_add_is_locked_to_chats.sql`
- API enforcement on `/api/chats/join` and `/api/invites/create`
- Documented in `architecture/LOCKED_ROOMS.md`

**Why:**
Moderation teams needed a way to freeze problematic rooms without deleting them. Event organizers wanted to close registration after capacity.

---

## Room Settings Redesign

**Three-Column Layout**

Room settings now use a clean three-column layout:
- Left: Navigation tabs
- Middle: Settings form
- Right: Preview/context panel

**Visual Updates:**
- Rounded corners on all cards
- Consistent spacing and padding
- Better visual hierarchy
- Icon improvements throughout

**Settings Organization:**

Settings are now grouped into clear sections:
1. **General** - Name, description, icon, use case
2. **Privacy** - Private room toggle, locked room toggle
3. **Members** - Member list, invites, permissions
4. **Shapes** - Configure AI shapes in room
5. **Advanced** - Danger zone, delete room

**Auto-Save + Loading States**

All settings now auto-save on change with clear loading indicators:
- Toggle switch → spinner appears → success toast
- Text input → debounced save → spinner → toast
- No manual "Save" button needed

**Improved Copy:**
- "Private Room" description: "Only invited members can see and join this room"
- "Locked Room" description: "Prevent new members from joining (existing members stay)"
- Clear action button labels

---

## Create Room Flow Improvements

**Removed "Create Shape" Option**

Deleted the ability to create a custom Shape during room creation.

**Before:** Create room → Page 4 → "Create a new Shape" option.
**After:** Create room → Choose from existing Shapes only.

**Why:**
- Feature was confusing (most users didn't understand it)
- Rarely used (< 5% of room creations)
- Complicated onboarding flow
- Users can still create Shapes separately

**Implementation:**
- Removed page 4 "create shape" variant entirely
- Simplified shape selection to existing shapes only
- Reduced create room flow from 5 pages → 4 pages
- Documented in `architecture/CREATE_ROOM_FLOW.md`

**Better Use Case Descriptions**

Updated use case selection page (page 1) with clearer descriptions:

- **Casual:** "Chat with friends, share memes, hang out"
- **Roleplay:** "Immersive storytelling, character-driven conversations"
- **Smart:** "Research, learning, expert knowledge"

**Icon Upload Improvements**

Room icon upload:
- Now shows image preview immediately after selection
- Clear "Remove" button to reset
- Better error handling for invalid files

---

## Profile System Overhaul

**New Profile Modal Design**

Completely redesigned user profile modal:

**Layout:**
- Full-screen modal (not sidebar)
- Cover image at top
- Avatar overlapping cover
- Bio section
- Badges section
- Stats section (rooms, messages, joined date)

**Badges Display:**
- Shows all user badges (team, sponsor, premium, level, room owner)
- Clickable badges open badge info tooltips
- Visual hierarchy: team badges first, then tier badges

**Actions:**
- Send DM button (if not self)
- Report user button
- Block user button (in DMs)
- Edit profile button (if self)

**Profile Privacy Settings**

New privacy controls for profiles:

**Private Profile Toggle:**
- Settings → Privacy → "Private Profile"
- When enabled:
  - Profile hidden from non-friends
  - No profile modal for strangers
  - Username still visible in chat

**Hide Online Status:**
- Settings → Privacy → "Hide Online Status"
- When enabled:
  - Always appear offline to others
  - You can still see others' status

**Implementation:**
- New columns: `profile_privacy`, `hide_online_status` on `users` table
- API enforcement on `/api/users/[id]/profile`
- Documented in `architecture/PROFILE_PRIVACY.md`

---

## Sidebar Improvements

**Custom Sections Reordering**

You can now drag-and-drop custom sidebar sections to reorder them.

**How it works:**
- Hover over section header → drag handle appears
- Drag section up/down
- Drop to new position
- Order saves automatically

**Technical details:**
- Uses `@dnd-kit/core` for drag-and-drop
- Order stored in `sidebar_section_order` user preference
- Syncs across devices

**Section Icons Updated**

Updated icons for default sidebar sections:
- **Favorites:** ⭐ → 🌟 (more vibrant)
- **Recents:** 🕐 → 📝 (clearer intent)
- **Shape Communities:** 🤖 → 🎭 (matches brand)

**Collapsed Sections Persist**

Sidebar section collapsed/expanded state now persists across sessions.

**Before:** Refresh page → all sections expanded.
**After:** Your collapse preferences saved.

**Implementation:**
- Stored in `sidebar_collapsed_sections` user preference
- Syncs via real-time preferences API

---

## Notification Improvements

**Notification Badges on Sidebar Sections**

Sidebar sections now show unread counts:
- Red dot for any unread in section
- Number badge showing total unread count
- Updates in real-time

**Smart Notification Grouping**

Notifications now group intelligently:
- "Alice and 3 others mentioned you in Room Name"
- "5 new messages in Room Name"
- Click grouped notification → opens room at first unread

**Notification Preferences**

New granular notification settings:

**Per-room controls:**
- All messages
- Mentions only
- Nothing

**Global controls:**
- Mute all rooms (Do Not Disturb mode)
- Desktop notifications on/off
- Sound on/off

**Access:** Room header menu → "Notification Settings"

**Implementation:**
- New table: `notification_preferences`
- Columns: `user_id`, `chat_id`, `level` (all/mentions/none)
- API: `/api/notifications/preferences`
- Documented in `architecture/NOTIFICATIONS.md`

---

## Message Reactions

You can now react to messages with emoji.

**How it works:**
- Hover message → reaction button appears
- Click → emoji picker opens
- Select emoji → reaction appears under message
- Click existing reaction → add your reaction
- Click your reaction → remove it

**Reaction Display:**
- Shows emoji + count
- Hover → tooltip shows who reacted
- Your reactions highlighted
- Max 6 unique emojis per message (oldest replaced)

**Technical details:**
- New table: `message_reactions`
- Columns: `message_id`, `user_id`, `emoji`, `created_at`
- Real-time sync via WebSocket
- Optimistic UI updates
- API: `/api/messages/[id]/reactions`

**Why:**
Users wanted lightweight interaction without full replies. Reactions are faster feedback.

---

## Voice Messages Improvements

**Waveform Visualization**

Voice messages now show animated waveform during playback.

**Features:**
- Visual amplitude display
- Playback progress indicator
- Click waveform to seek
- Responsive to container width

**Implementation:**
- Uses Web Audio API for waveform analysis
- Canvas rendering for performance
- Cached waveform data per message

**Playback Speed Control**

Voice message player now has speed control:
- 1x (normal)
- 1.5x
- 2x

**Access:** Click speed indicator while playing.

**Speed Persists**

Your playback speed preference saves across messages.

---

## Search Improvements

**Global Search (Cmd+K) Enhancements**

**Search History:**
- Recent searches saved
- Quick access to previous queries
- Clear history option

**Search Filters:**
- `in:room-name` - Search within specific room
- `from:username` - Messages from user
- `has:image` - Messages with images
- `has:voice` - Voice messages
- `before:2025-10-15` - Date filters
- `after:2025-10-01` - Date filters

**Search Results Improvements:**
- Message preview with context
- Jump to message in room
- Highlight matching text
- Grouped by room

**Performance:**
- Debounced search (300ms)
- Cancel previous requests
- Cached results
- Virtualized list for large result sets

**Implementation:**
- Updated `/api/search/messages` with filter parsing
- Full-text search on PostgreSQL
- Indexed `messages.content` for performance
- Documented in `architecture/SEARCH.md`

---

## Moderation Tools

**Bulk User Actions**

Moderators can now take bulk actions on users:

**How it works:**
- Moderation panel → Users tab
- Select multiple users (checkboxes)
- Bulk actions dropdown:
  - Ban selected users
  - Mute selected users
  - Remove from room
  - Send warning message

**Action Confirmation:**
- Shows count of selected users
- Requires reason input for bans/mutes
- Confirmation modal prevents accidents

**Audit Log**

All moderation actions now logged:
- Who performed action
- What action (ban, mute, delete, etc.)
- Target user/message/room
- Reason provided
- Timestamp

**Access:** Super editorial only, in moderation panel.

**Implementation:**
- New table: `moderation_audit_log`
- API: `/api/moderation/audit-log`
- Filterable by action type, moderator, date range
- Documented in `architecture/MODERATION_AND_BANS.md`

**Message Filtering Keywords**

New automated content filtering:

**How it works:**
- Super editorial configures banned keywords/phrases
- Messages containing keywords auto-flagged
- Moderators notified in real-time
- Can auto-delete or hold for review

**Configuration:**
- Settings → Moderation → Content Filters
- Add keywords/phrases
- Set action (flag/delete/mute user)
- Regex support for advanced patterns

**Implementation:**
- Keyword matching at message send time
- Fast in-memory regex engine
- Logged in audit trail

---

## Performance Optimizations

**Message List Virtualization**

Chat message lists now use virtual scrolling for better performance.

**Before:** Render all messages in room (slow for large rooms).
**After:** Render only visible messages + small buffer.

**Impact:**
- 10,000 message room: ~50ms → ~5ms render time
- Smooth scrolling even in huge rooms
- Lower memory usage

**Implementation:**
- Uses `@tanstack/react-virtual`
- Dynamic item sizing
- Scroll position restoration

**Image Lazy Loading**

Images in chat now lazy load as you scroll.

**Features:**
- Blur placeholder while loading
- Progressive JPEG support
- Intersection Observer API
- Cancels requests when scrolled away

**Impact:** Faster initial page load, less bandwidth waste.

**Database Query Optimizations**

**Indexed columns:**
- `messages.chat_id` + `messages.created_at` (composite index)
- `chat_participants.user_id` + `chat_participants.chat_id`
- `message_reactions.message_id`

**Query improvements:**
- Reduced N+1 queries in message fetching
- Batch profile data loading
- Optimized joins on participant queries

**Impact:** 40% faster message loading on average.

---

## Bug Fixes

**Fixed Voice Message Playback Interruption**

Fixed voice messages stopping when new messages arrived (re-implemented after revert).

**Solution:** Audio player context now preserves playback across message list updates.

**Fixed Emoji Picker Position on Mobile**

Emoji picker no longer appears off-screen on mobile devices.

**Fixed Message Edit Race Condition**

Fixed rare bug where editing a message while someone else edited it would lose changes.

**Solution:** Optimistic locking with version numbers.

**Fixed Notification Badge Count**

Fixed unread count not updating after marking room as read.

**Fixed Profile Avatar Upload**

Fixed avatar upload failing for images over 2MB.

**Solution:** Client-side compression before upload.

**Fixed Search Result Highlighting**

Search result highlights now properly escape HTML in message content.

**Fixed DM Block Status Check**

Fixed DM block status not checking correctly for bidirectional blocks.

---

## Developer Experience

**TypeScript Strict Mode**

Enabled TypeScript strict mode across entire codebase.

**Changes:**
- `strictNullChecks: true`
- `strictFunctionTypes: true`
- `noImplicitAny: true`
- `noImplicitThis: true`

**Impact:** Caught 200+ potential runtime bugs during compilation.

**API Route Documentation**

All API routes now documented in `architecture/API_ROUTES_ALPHABETICAL.md`:
- Request/response types
- Authentication requirements
- Rate limits
- Example requests
- Error codes

**Component Storybook**

Added Storybook for UI component development:
- All reusable components have stories
- Visual regression testing
- Interactive prop controls
- Accessibility checks

**Access:** `npm run storybook`

---

## Mobile App Updates

**Push Notifications on iOS**

iOS app now supports push notifications.

**Features:**
- Message notifications
- Mention notifications
- Reaction notifications
- Configurable per-room settings

**Implementation:**
- APNs integration
- Background message sync
- Notification grouping

**Haptic Feedback**

Added haptic feedback for key interactions:
- Message sent
- Reaction added
- Button taps
- Pull to refresh

**Offline Mode Improvements**

Better offline experience:
- Queue messages for send when back online
- Show offline indicator in UI
- Cached messages available offline
- Auto-retry failed sends

---

## Accessibility Improvements

**Keyboard Navigation**

Full keyboard navigation support:
- `Tab` through all interactive elements
- `Enter` to activate buttons
- `Escape` to close modals
- `Arrow keys` in message list
- `Cmd+K` for search
- `Cmd+/` for shortcuts menu

**Screen Reader Support**

Improved screen reader experience:
- Proper ARIA labels on all buttons
- Live region announcements for new messages
- Semantic HTML throughout
- Alt text required for images

**Focus Management**

Better focus management:
- Modal open → focus moves to modal
- Modal close → focus returns to trigger
- Toast notifications don't steal focus
- Skip to content link

**Color Contrast**

All UI elements now meet WCAG AA standards:
- Text: 4.5:1 contrast minimum
- Large text: 3:1 contrast minimum
- Interactive elements: clear focus indicators

---

*Shipped by the team at [shapes.inc](http://shapes.inc). Feedback? Drop it in [Forums](/forums) or DM [@shapes](https://talk.shapes.inc/u/shapes/dm)!*