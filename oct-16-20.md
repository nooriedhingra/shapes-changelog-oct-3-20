# Shapes.inc Changelog - October 16-20, 2025

## Locked Rooms

Room owners can now lock rooms to prevent new joins/invites.

**How it works:**
- Room owner ‚Üí Room Settings ‚Üí Moderation ‚Üí "Lock Room" toggle
- Locked rooms show üîí lock icon in room list and header
- Join page shows "This room is locked" message
- Invite API blocked: returns error if room locked
- Join API blocked: returns error if room locked

**Who can still access:**
- Existing participants (unaffected)
- Room owner (always has access)
- Super editorial staff (moderation override)

**Use cases:**
- Private discussions that are "closed" after initial setup
- Event rooms that should stop accepting participants
- Moderation: freeze problem rooms

**Implementation:**
- New column: `chats.is_locked` (boolean, default false)
- API middleware checks lock status
- UI shows lock icon + messaging
- Documented in `architecture/MODERATION_AND_BANS.md`

---

## Search Improvements

### Global Search (Cmd+K)

**Search Everything at Once**

Cmd+K now searches across:
- Your rooms
- Your DMs
- Your favorites
- Shape community rooms
- Public directory rooms
- Users

**Before:** Separate tabs for Rooms/Users/Directory.
**After:** One unified search, all results mixed by relevance.

**Smart grouping:**
- Results grouped by type (Rooms, DMs, Favorites, Users)
- Each group shows top 5 results
- Click "See all" to expand full category

**Performance:**
- Parallel API requests (all searches run at once)
- Results stream in as they complete
- Fast, responsive, no blocking

**Documented in `architecture/COMMAND_PALETTE.md`**

### Room Search Polish

**Search by Display Name**

Room search `from:username` now supports display names.

**Before:** Only matched exact usernames.
**After:** Matches display names too.

**Example:**
- User: `@alice` with display name "Alice Chen"
- Search: `from:alice` ‚Üí works
- Search: `from:Alice Chen` ‚Üí also works

**Case-insensitive matching** for both username and display name.

**Better Error Messages**

Search errors now show helpful messages:
- "User not found" if `from:username` doesn't exist
- "No messages found" if search returned empty
- "Search failed" for API errors

**Loading States**

Proper loading spinner while search runs. No more blank screen.

---

## Voice Improvements

### Voice Participant UI

**Avatar Rings**

Users in voice now show with colored rings around avatars.

**States:**
- üü¢ Green ring: actively speaking
- ‚ö™ White ring: in voice, not speaking
- No ring: not in voice

**Where you see it:**
- Room participant list
- Voice modal participant list
- Chat message avatars (if user is in voice)

**Technical:**
- WebSocket updates voice state in real-time
- Efficient re-renders (only affected avatars update)

### Voice Modal Polish

**Participant Count Badge**

Voice button now shows participant count badge.

**Example:** "üéôÔ∏è Voice (3)" if 3 people in voice.

**Click voice button ‚Üí modal shows:**
- List of all participants
- Who's speaking (green ring)
- Who's muted
- Join/Leave buttons

**Mute Indicator**

Muted participants show üîá mute icon next to name.

**Self-Mute Toggle**

You can mute/unmute yourself in voice modal.

**Join/Leave Polish**

"Join Voice" button turns into "Leave Voice" when you're connected.

---

## Message Interactions

### Emoji Reactions

**React to Messages with Emoji**

Click message ‚Üí emoji picker ‚Üí select emoji ‚Üí reaction added.

**Features:**
- Multiple users can react with same emoji (shows count)
- Click your reaction to remove it
- Hover reactions to see who reacted
- Reactions persist across sessions

**UI:**
- Reaction bubbles below message
- Count badge on each unique emoji
- Your reactions highlighted

**Implementation:**
- New table: `message_reactions`
- WebSocket broadcasts reactions in real-time
- Optimistic UI updates

### Message Threads (Preview)

**Reply in Thread**

Click "Reply in thread" on any message to start a thread.

**How it works:**
- Original message shows thread count badge: "3 replies"
- Click badge ‚Üí thread panel opens (side panel)
- Reply in thread ‚Üí doesn't clutter main chat
- Thread participants get notifications

**Status:** Backend ready, UI in progress. Coming soon.

---

## Onboarding Improvements

### Profile Setup Flow

**Required Profile Photo**

New users must upload profile photo before accessing app.

**Flow:**
1. Sign up ‚Üí lands on profile setup page
2. Upload photo (required)
3. Set display name (required)
4. Set bio (optional)
5. Click Continue ‚Üí enters app

**Why:** Profile photos improve community trust and engagement.

**Skip option:** None. Photo is required.

### Welcome Room Auto-Join

New users automatically join "Welcome to Shapes" room on signup.

**What's in Welcome room:**
- Getting started guide
- Community guidelines
- Tips and tricks
- Shape assistant to answer questions

**You can leave anytime.** It's just auto-added to help new users.

---

## Notifications

### Desktop Notifications

**Browser Push Notifications**

Shapes now sends desktop notifications for:
- New messages in DMs
- @mentions in rooms
- Replies to your messages
- Thread updates

**Setup:**
- First time: browser asks for permission
- Grant permission ‚Üí notifications enabled
- Deny ‚Üí no notifications (you can enable later in Settings)

**Smart behavior:**
- Only notifies when tab is in background
- Doesn't spam (groups multiple messages)
- Click notification ‚Üí opens that chat

**Settings:**
- Settings ‚Üí Notifications ‚Üí toggle types on/off
- Mute specific rooms
- DND mode (snooze all notifications)

### Unread Count Badge

**Browser Tab Badge**

Unread message count now shows in browser tab title.

**Example:** "(3) Shapes - alice's room" if you have 3 unread.

**Clears when:** You view the chat with unread messages.

---

## Room Settings Improvements

### Room Visibility Control

**Private Rooms**

Room owners can now make rooms private.

**Private room behavior:**
- Hidden from public directory
- Hidden from Shape community lists
- Only accessible via direct link or invite
- Participants can still see and access

**How to enable:**
Room Settings ‚Üí Privacy ‚Üí "Private Room" toggle

**Use cases:**
- Friend group chats
- Work team rooms
- Private communities

### Room Icon Upload

**Custom Room Icons**

Room owners can upload custom room icons.

**Before:** Rooms showed default gradient icon.
**After:** Upload any image (JPG, PNG, GIF).

**Requirements:**
- Max 5MB file size
- Square images work best (auto-cropped to circle)

**Where icon shows:**
- Room list sidebar
- Room header
- Directory listings
- Notifications

---

## Moderation Tools

### Message Deletion

**Delete Messages**

Room owners and super editorial can delete messages.

**How it works:**
- Click message menu ‚Üí "Delete message"
- Confirm ‚Üí message deleted for everyone
- Shows "Message deleted" placeholder
- Original sender sees who deleted it

**Permissions:**
- Your own messages: always deletable
- Others' messages: room owner or super editorial only

**Implementation:**
- Soft delete (message marked deleted, not removed from DB)
- Audit log tracks who deleted what
- Super editorial can view deleted messages

### User Kicks

**Kick Users from Rooms**

Room owners can kick disruptive users.

**How it works:**
- Click user ‚Üí "Kick from room"
- User immediately removed from room
- User can rejoin (unless room is locked or invite-only)

**Kick vs Ban:**
- Kick: temporary removal, can rejoin
- Ban: permanent removal, cannot rejoin

**Message shows:** "[User] was kicked from the room"

---

## Performance & Infrastructure

### Message Pagination

**Infinite Scroll for Chat History**

Chat now loads messages in batches as you scroll up.

**Before:** Loaded last 100 messages on room open.
**After:**
- Loads last 50 messages initially
- Scroll to top ‚Üí loads next 50
- Continues until you reach room start

**Why:** Faster initial load, less memory usage, smoother performance.

**Smart loading:**
- Preserves scroll position when loading more
- Shows loading indicator at top
- Caches loaded messages (no refetch on scroll down)

### WebSocket Optimization

**Connection Pooling**

Reduced WebSocket connections from N (one per room) to 1 (shared connection).

**Before:** 10 open rooms = 10 WebSocket connections.
**After:** 10 open rooms = 1 WebSocket connection.

**Impact:**
- Lower server load
- Faster connection establishment
- Better mobile battery life

**Room Subscription Model:**
- Connect ‚Üí subscribe to rooms you're viewing
- Switch room ‚Üí unsubscribe from old, subscribe to new
- Close room ‚Üí unsubscribe

### Image Upload Optimization

**Client-Side Image Compression**

Images now compressed before upload.

**Before:** Upload 5MB photo ‚Üí 5MB sent to server.
**After:** Upload 5MB photo ‚Üí compressed to ~500KB ‚Üí 500KB sent.

**Quality settings:**
- Photos: 85% quality (visually identical)
- Screenshots: 90% quality
- Max dimension: 2048px (downscaled if larger)

**Impact:**
- 10x faster uploads
- Lower bandwidth usage
- Faster image loading in chat

---

## Mobile Web Improvements

### Mobile Compose Bar

**Fixed Keyboard Overlap**

Composer now stays above keyboard on mobile.

**Before:** Keyboard would cover composer (had to scroll to see what you're typing).
**After:** Composer floats above keyboard, always visible.

**Implementation:**
- Visual viewport API
- Dynamic height adjustments
- Smooth keyboard transitions

### Pull-to-Refresh

**Refresh Chat with Pull Gesture**

Mobile users can now pull down to refresh chat.

**How it works:**
- Pull down at top of chat ‚Üí shows refresh indicator
- Release ‚Üí reloads messages
- Useful if messages seem stuck/out of sync

**Disabled when:** You're not scrolled to top (prevents accidental refreshes).

### Mobile Voice Modal

**Full-Screen Voice on Mobile**

Voice modal now goes full-screen on mobile.

**Before:** Tiny modal, hard to see participants.
**After:** Full screen, easy to see who's talking.

**Swipe down to close.**

---

## Bug Fixes

**Fixed message send on iOS Safari**

Fixed bug where pressing Enter on iOS would sometimes not send message.

**Fixed emoji autocomplete on Android**

Emoji autocomplete (`:smile:`) now works on Android keyboards.

**Fixed voice reconnection loop**

Fixed rare bug where voice would disconnect and reconnect infinitely.

**Fixed duplicate reactions**

Fixed race condition allowing duplicate reactions from same user.

**Fixed room list scroll jump**

Room list no longer jumps to top when new message arrives.

**Fixed profile modal on mobile**

Profile modal now properly sized on mobile (was overflowing screen).

**Fixed command palette focus trap**

Fixed Cmd+K modal trapping focus after close (Esc now properly returns focus).

**Fixed message timestamp timezone**

Message timestamps now show in your local timezone (not UTC).

**Fixed notification permission prompt timing**

Notification permission now asks after first message sent (not immediately on signup).

**Fixed search result highlighting**

Search results now properly highlight matched text.

**Fixed deleted room access**

Fixed bug allowing non-staff users to access deleted rooms via direct link.

**Fixed reaction overflow**

Messages with 10+ unique reactions now show "..." overflow with count.

**Fixed voice modal z-index**

Voice modal now appears above all other modals (was sometimes hidden).

**Fixed thread count update**

Thread reply counts now update in real-time when others reply.

**Fixed image lightbox on mobile**

Image zoom now works properly on mobile (pinch gesture support).

**Fixed room icon crop**

Uploaded room icons now properly cropped to circle (no stretching).

**Fixed private room invite**

Private room invites now work (was blocked by visibility check).

**Fixed DM block notification**

Blocked users no longer get notification when you send message (was leaking block status).

**Fixed message edit race condition**

Fixed bug where rapid edits could result in wrong version being saved.

**Fixed WebSocket reconnection backoff**

WebSocket now uses exponential backoff on reconnection (was hammering server on network issues).

**Fixed scroll position on room switch**

Switching rooms now properly scrolls to bottom (was sometimes stuck mid-scroll).

---

## Design Updates

### New Color Palette

**Refreshed Brand Colors**

Updated primary colors:
- Primary: #6366F1 (indigo)
- Success: #10B981 (green)
- Warning: #F59E0B (amber)
- Error: #EF4444 (red)

**Better contrast ratios** for accessibility.

### Typography Updates

**Inter Font Family**

Switched to Inter for all UI text.

**Why:** Better readability, modern look, excellent at small sizes.

**Font weights:**
- Regular (400): body text
- Medium (500): labels, buttons
- Semibold (600): headings
- Bold (700): emphasis

### Icon Refresh

**Lucide Icons**

Replaced old icon set with Lucide.

**Why:** Consistent style, better coverage, smaller bundle size.

**All icons updated:**
- Navigation icons
- Action buttons
- Status indicators
- Settings icons

---

*Shipped by the team at [shapes.inc](http://shapes.inc). Feedback? Drop it in [Forums](/forums) or DM [@shapes](https://talk.shapes.inc/u/shapes/dm)!*