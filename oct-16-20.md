# Shapes.inc Changelog - October 16-20, 2025

## Locked Rooms

Room owners can now lock rooms to prevent new members from joining.

**How it works:**
- Room settings → Moderation → "Lock Room" toggle
- Locked rooms block all new joins and invites
- Existing members stay in the room
- Only room owners can lock/unlock

**What users see:**
- Join page: "This room is locked. New members cannot join at this time."
- Invite attempts: "This room is locked" error
- Room card: 🔒 lock icon badge

**Technical details:**
- New `is_locked` column on `chats` table
- Migration: `20251013_add_is_locked_to_chats.sql`
- API enforcement in `/api/chat/invite` and `/api/chats/join`
- Documented in `architecture/LOCKED_ROOMS.md`

**Why:**
Moderators needed a way to stop trolls from rejoining without fully deleting the room.

---

## Room Settings UX Overhaul

**Redesigned Settings Modal**

Completely rebuilt room settings UI for clarity and organization.

**New structure:**
- **General tab:** name, description, image, privacy
- **Shapes tab:** configure Shape participants
- **Moderation tab:** lock room, ban users, delete room
- **Advanced tab:** skills, integrations, persona settings

**Visual improvements:**
- Consistent spacing and typography
- Section headers with descriptions
- Better button hierarchy
- Loading states on all actions
- Success/error toasts

**Behavior changes:**
- Auto-save on all toggles (no manual Save needed)
- Disabled states show clear messaging
- Dangerous actions (delete, lock) in Moderation tab

**Implementation:**
- Split monolithic settings component into tab components
- Shared hooks for save logic
- Consistent styling with design system

---

## Voice Message Improvements

**Waveform Visualization**

Voice messages now show animated waveforms during playback.

**How it works:**
- Record voice message → waveform generated from audio peaks
- Play message → waveform animates with playback position
- Pause → waveform freezes at current position

**Technical details:**
- Web Audio API analyzes audio buffer
- Canvas rendering for smooth animation
- Cached waveform data per message
- GPU-accelerated on supported devices

**Recording UX Polish**

Improved voice recording interface:
- Live timer during recording
- "Cancel" and "Send" buttons clearly labeled
- Haptic feedback on mobile (start/stop recording)
- Visual pulse animation while recording

**Playback Controls**

Enhanced voice message player:
- Scrub through waveform by clicking
- Playback speed: 1x, 1.5x, 2x toggle
- Remaining time display
- Auto-collapse after playback ends

---

## Search Improvements

**Global Search (Cmd+K) Enhancements**

**Shape communities now searchable:**
- Cmd+K → type query → see public Shape rooms
- Previously only showed your rooms/DMs

**Better result grouping:**
- Your Rooms (top)
- Favorites (⭐ badge)
- Direct Messages
- Shape Communities
- Users

**Keyboard navigation:**
- Arrow keys to navigate results
- Enter to open
- Esc to close

**Room Search Polish**

In-room message search improvements:

**from:username syntax:**
- `from:alice project` finds "project" messages from alice
- Resolves usernames via profile cache
- Works with display names and @handles

**Submit-to-search (not live):**
- Press Enter or click search icon to execute
- Prevents API spam from every keystroke
- Clear button to reset search

**Better empty states:**
- "No messages found" with search tips
- Suggestions: try different keywords, check spelling, use from:username

---

## Moderation Tools

**Ban User Improvements**

Enhanced user banning flow:

**New ban options:**
- Ban from room only (room-level)
- Ban from platform (global, requires super editorial)
- Ban + delete all messages
- Ban + kick from all rooms

**Ban modal shows:**
- User's recent activity
- Number of messages in current room
- Number of rooms user is in
- Previous ban history

**Post-ban cleanup:**
- Option to delete banned user's messages
- Option to remove from all rooms they're in
- Confirmation step for global bans

**Message Filtering**

Messages from banned users are now hidden from chat feeds.

**Behavior:**
- Globally banned users: messages hidden for all non-staff
- Room-banned users: messages hidden in that room only
- Super editorial: can always see banned user messages
- Message count updates accordingly

**UID Search in Moderation Panel**

Moderators can now search users by UID (user ID).

**Why:** User IDs are permanent, emails/usernames can change. UID search never fails.

**How to use:**
- Moderation panel → Users tab
- Search bar accepts: email | username | UID
- New API: `/api/users/search-by-uid`

**Deleted Room Badge**

Moderation UI now shows "Deleted" badge for deleted rooms.

**Staff powers:**
- Super editorial can view deleted rooms
- Chat page allows deleted room access for staff
- Room info API returns deleted room data for moderation

---

## DM Privacy Features

**Block Users in DMs**

You can now block users in direct messages.

**How it works:**
- Open DM → click user menu → "Block user"
- Blocked users can't message you
- You can't message blocked users
- One-directional: blocking is not mutual
- Unblock anytime from DM header

**What you see:**
- Banner: "You blocked this user" or "This user blocked you"
- Composer disabled with explanation
- Clear unblock button in header

**Technical details:**
- New table: `user_dm_blocks` with directional blocking
- API route: `/api/dm-blocks` (block, unblock, status)
- Enforced at DM creation and message send
- Documented in `architecture/user-dm-privacy.md`

---

## Chat UX Improvements

**Image Zoom in Chat**

Click images in chat → full-screen lightbox with zoom.

**Features:**
- Pinch to zoom (mobile)
- Scroll to zoom (desktop)
- Pan zoomed images
- Click outside to close
- GPU-accelerated transforms

**Emoji Picker Fixes**

Fixed emoji picker focus issues:

**Before:** Open emoji picker on mobile → keyboard pops up (annoying).
**After:** Emoji picker stays focused, keyboard stays hidden.

**Implementation:**
- Tagged emoji UI with `data-prevent-composer-autofocus`
- Desktop keydown handler skips emoji picker elements
- Mobile touch events don't trigger composer focus

**Emoji Autocomplete Dismissal**

Emoji shortcode autocomplete (`:smile:`) now closes after space.

**Before:** Type `:smile: ` → autocomplete stayed open.
**After:** Space after shortcode → autocomplete closes immediately.

**Text Commands Don't Stick**

Typed commands (like `!imagine`) now only apply to current message.

**Before:**
- Type `!imagine cats` → sends image generation
- Next message ALSO in image mode (sticky)

**After:**
- Type `!imagine cats` → sends image generation
- Next message returns to normal text

**Button behavior unchanged:**
- Click Image button → stays active (sticky mode)
- Click again to toggle off

**Why:** Typed commands feel one-time. Buttons feel like mode switches. Behavior now matches intent.

**"Copy Message Link" Moved to Bottom**

Message action menu reordered: "Copy Message Link" now at bottom (after Delete/Report/Kick/Ban).

**Voice Message Playback Fix**

Fixed voice messages stopping when new messages arrived.

**What was broken:**
Audio player unmounted on new message, killing playback.

**Solution:**
- React context tracks active audio players
- New messages don't unmount active players
- Playback continues smoothly

---

## Starter Message Suggestions

**AI-Generated Conversation Starters**

New rooms now show AI-generated suggestions to kickstart conversation.

**How it works:**
- Join/create room with no messages from you
- 1 suggestion bubble appears after Shape greeting
- Click suggestion → fills composer (doesn't auto-send)
- Edit before sending
- After first message → suggestion disappears

**Smart behavior:**
- Only YOUR message count matters (not others)
- Hides "@mention a shape" hint when suggestion visible
- Cached per room (no duplicate API calls)
- Graceful error handling if API fails

**Reduced from 3 → 1 Suggestion**

**Why:** 3 was too aggressive, felt spammy. 1 is enough to kickstart conversation.

**Wand Icon + Loading Message**

- Icon: Magic Wand 🪄 (matches AI features)
- Loading: "Generating a reply... this may take a few seconds"

**ChatId Parameter**

Suggested replies API now accepts `chatId` for context-aware suggestions.

---

## Badge System Improvements

**Smart Badge Display**

Badges now show intelligently based on context.

**In chat messages:**
- Show only TOP 1 badge
- Priority: team > sponsor > premium > room owner > level
- Cleaner message UI

**In profile modal:**
- Show ALL badges (team, sponsor, premium, level, room owner)
- Full badge collection visible

**Clickable Badges**

Badges in chat are now clickable — opens user profile modal.

**Premium Badge Added**

New "Premium" badge for premium subscribers.

**Shows when:**
- User has active premium subscription
- Displays in profile modal and chat (if top priority)

**Removed Badge Preferences**

Deleted old "badge preferences" UI. Too confusing, no longer needed with smart display logic.

---

## Room Directory Improvements

**Activity-Based Sorting**

Room directory now sorts by latest message time.

**How it works:**
- SQL subquery gets `MAX(message.createdAt)` per room
- Sort by freshest message timestamp
- Most recently active rooms at top
- Timezone-aware (shows "7 hours ago" correctly)

**Technical details:**
- Added `AT TIME ZONE 'UTC'` to timestamp fields
- Removed client-side re-sorting (~70 lines deleted)
- SQL does all sorting before pagination

**Removed Upvoting**

Removed upvote buttons and vote counts from room directory.

**Before:** Users could upvote rooms, votes determined ranking.
**After:** No voting UI, rooms sorted by activity.

**Why:** Upvotes were gameable and didn't reflect actual room quality. Activity-based ranking is more honest.

**Load 100 Rooms at Once**

Increased directory page size from 20 → 100 rooms per load.

**Why:** Users complained about excessive "Load More" clicking.

**Fixed Interaction Modal Bleeding**

Fixed visual bug where interaction modal content would overflow container bounds.

---

## Create Room Modal UX

**Auto-Scroll to Top on Page Change**

Modal now scrolls to top when you click Next/Back between pages.

**Before:** Click Next → page changes but scroll position stays mid-page.
**After:** Page changes → instant scroll to top. Clean experience.

**Clickable Upload Boxes**

Image/icon upload boxes are now fully clickable.

**Before:** Had to click tiny "Upload" text.
**After:** Click anywhere on picture box → file picker opens.

**Fixed Ellipsis Overflow**

Long Shape names now wrap properly with ellipsis. No more text bleeding outside containers.

**Removed Duplicate Back Button**

Create room modal had TWO back buttons (header + footer). Removed footer back button.

**Persona Feature Gating**

**Before:** Persona settings shown to all users.
**After:**
- Roleplay use case → persona at top of page 4
- Casual/Smart use case → persona hidden entirely

**Why:** Personas only make sense for roleplay. Don't confuse other users.

---

## Persona UI Improvements

**Better Form Labels**

Updated persona creation form:
- Labels: "MY NAME" and "MY BACKSTORY" (clearer)
- Hint text: helpful examples matching shapes.inc style
- Placeholders: concrete examples (kpop stan, basketball player, etc.)

**Scrollable Persona Cards**

Persona management cards:
- Span full profile width
- Scrollable instruction text (thin viewports)
- Single-column layout
- Edit/delete actions inline with default toggle

**Hidden Nav Buttons**

Removed "Chat Now", "Profile", "Copy link" buttons from personas page. Unnecessary clutter.

---

## Settings Reorganization

**Private Account Toggle Moved**

Moved "Private Account" toggle from sidebar dropdown → Settings popup.

**Before:** Sidebar user menu → scroll down → private account toggle (buried).
**After:** Settings icon → Privacy section → private account toggle (clear).

**Why:** Better discoverability. Privacy settings belong in Settings.

**Configure Shapes Hidden for Non-Owners**

"Configure Shapes" option in room settings now hidden for non-owners.

**Before:** All room members saw "Configure Shapes" (clicking did nothing).
**After:** Only room owners see the option.

**Behavior:**
- User DMs: option hidden (no Shapes to configure)
- Shape DMs: option shown (you're always the owner)
- Multiplayer rooms: owners only

**Room Skills Auto-Save**

Room skills toggle now:
- Auto-saves on toggle (no Save button needed)
- Shows loading spinner during save
- Toast confirms success

**Web and Image Buttons Hidden in User DMs**

Composer toolbar in user DMs no longer shows:
- Web search button
- Image generation button

**Why:** These features don't work in DMs. No point showing buttons that don't work.

---

## Performance Improvements

**Fixed Batch Voice Status N+1 Queries**

Voice status endpoint was making N queries for N shapes.

**Before:** Fetch 10 shapes → 10 separate DB queries.
**After:** Fetch 10 shapes → 1 batch query.

**Impact:** Faster sidebar Shape voice status indicators.

**Fetch Shapes Info on Layout**

Moved Shape info fetching to layout level for better caching.

**Before:** Every page refetched Shape data.
**After:** Layout fetches once, all pages reuse.

---

## Bug Fixes

**Fixed Forum Page Layout Issues**

Carried over from oct 9, implemented oct 10-16.

**Auto-Redirect from Join Page**

If you're already in a room, `/r/[slug]/join` now auto-redirects to `/chat/[id]`.

**Before:** Already a participant → still saw join form (confusing).
**After:** Already in → instant redirect to chat.

**Fixed Rewards Level Display**

Fixed visual bug in rewards modal showing wrong level badges.

**Fixed Custom Section Search**

Sidebar custom sections (like "Favorites") now properly filter rooms when you search.

**Before:** Search in custom section → showed all rooms.
**After:** Search filters within that section only.

**Fixed Instruction Modal Placeholder Bleeding**

Long placeholder text in instruction modals now wraps properly instead of overflowing.

---

## Session Management

**Session Timeout Fix (Stay Logged In)**

Fixed users getting logged out unexpectedly.

**What was broken:**
Auth0 session duration wasn't set in code — env vars were ignored.

**What we fixed:**
- Rolling duration: 100 days (idle time before logout)
- Absolute duration: 365 days (max session life)
- Sessions auto-refresh on any visit

**User impact:**
- Stay inactive for 100 days → still logged in
- Active users effectively "logged in forever"
- No more surprise logouts

**Implementation:**
- Explicit session params in all `initAuth0()` calls
- Aligned Auth0 dashboard to match code settings
- Documented in `architecture/AUTH0_SESSION_DURATION_FIX.md`

---

## Rewards Updates

**Deadline Changed to Monday 00:00 UTC**

Weekly rewards deadline moved from Sunday → Monday midnight UTC.

**Why:** Aligns with backend week changes (Monday-Sunday weeks).

**+24hr Bonus Banner (Expired Oct 13)**

One-time bonus banner showed until Oct 13:

```
🎁 Bonus! We gave you +24hrs
~~3h 42m left~~ (strikethrough)
1d 3h 42m left! (new deadline)
```

Banner no longer active.

---

*Shipped by the team at [shapes.inc](http://shapes.inc). Feedback? Drop it in [Forums](/forums) or DM [@shapes](https://talk.shapes.inc/u/shapes/dm)!*