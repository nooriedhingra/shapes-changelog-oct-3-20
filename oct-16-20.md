# Shapes.inc Changelog - October 16-20, 2025

## Locked Rooms

Room owners can now lock rooms to prevent new members from joining.

**How it works:**
- Room owner ‚Üí Settings ‚Üí "Lock Room"
- Locked rooms show üîí icon in header
- Join links disabled (show "This room is locked" message)
- Invite API blocked
- Existing members unaffected

**Use cases:**
- Private groups that are full
- Completed projects (archive mode)
- Temporary closure during moderation

**Technical details:**
- New column: `chats.is_locked` (boolean, default false)
- Migration: `0066_room_locking.sql`
- API enforcement in `/api/chat/[id]/invite` and join endpoints
- Lock toggle in moderation UI
- Documented in `architecture/ROOM_LOCKING.md`

**Why:**
Users wanted to close rooms without deleting them. Now you can freeze membership while keeping existing conversations active.

---

## Room Privacy: Private Rooms

Create truly private rooms that don't appear in directory or search.

**How it works:**
- Create room ‚Üí toggle "Private Room"
- Private rooms:
  - Hidden from room directory
  - Not searchable
  - Only accessible via direct link or invite
  - Members can still find in sidebar/recents

**Settings:**
- Room owner can toggle privacy anytime
- Changes apply immediately
- No affect on existing members

**Technical details:**
- New column: `chats.is_private` (boolean, default false)
- Directory queries filter `WHERE is_private = false`
- Search excludes private rooms
- Documented in `architecture/ROOM_PRIVACY.md`

**Why:**
Not every room should be public. Private rooms let you collaborate without broadcasting to the world.

---

## Sidebar Redesign

### New Sections: Rooms, Shape DMs, User DMs

Sidebar now organized into clear categories.

**New structure:**
```
üè† Home
üìÅ Rooms
  ‚îú‚îÄ My Rooms
  ‚îú‚îÄ Shape Communities  
  ‚îî‚îÄ [Custom sections]
üí¨ Shape DMs
üë§ User DMs
üåç Directory
üèÜ Rewards
‚öôÔ∏è Settings
```

**Rooms section:**
- All multiplayer rooms (your rooms + joined rooms)
- Custom sections (Favorites, etc.)
- Shape communities

**Shape DMs:**
- All your Shape conversations
- Sorted by recent activity
- Voice status indicators

**User DMs:**
- All human-to-human DMs
- Sorted by recent activity
- Online status indicators

**Why:**
Old sidebar mixed everything together. New structure makes it obvious where to find conversations.

### Collapsible Sections

All sidebar sections now collapsible.

**How it works:**
- Click section header ‚Üí collapse/expand
- State persists across sessions (localStorage)
- Chevron icon shows expand/collapse state

**Default states:**
- Rooms: expanded
- Shape DMs: expanded  
- User DMs: expanded

**Technical details:**
- `useSidebarState` hook manages collapse state
- Smooth animations via Framer Motion
- Documented in `architecture/SIDEBAR_REDESIGN.md`

### Favorites as Custom Section

Favorites moved from top-level ‚Üí custom section under Rooms.

**Before:** ‚≠ê Favorites (top-level category)
**After:** üìÅ Rooms ‚Üí ‚≠ê Favorites (nested section)

**Why:** Favorites are rooms. Nesting them under Rooms makes logical sense.

### Search Within Sections

Sidebar search now scopes to active section.

**How it works:**
- In "Rooms" section ‚Üí search filters rooms only
- In "Shape DMs" ‚Üí search filters Shape DMs only
- In "User DMs" ‚Üí search filters user DMs only

**Global search:**
- Click search icon in header (not in section)
- Opens Cmd+K palette with all results

**Why:** Scoped search is faster and less cluttered.

---

## Voice Messages UX Improvements

### Waveform Visualization

Voice messages now show animated waveforms during playback.

**What you see:**
- Recording: live waveform animates as you speak
- Sent message: static waveform shows audio shape
- Playing: waveform highlights in sync with playback

**Technical details:**
- Canvas-based rendering
- Audio analysis via Web Audio API
- Cached waveform data per message
- GPU-accelerated animations

**Why:**
Static audio bubbles were boring. Waveforms give visual feedback and look modern.

### Playback Speed Control

**Coming soon** (backend ready, UI in progress):
- 0.5x, 1x, 1.5x, 2x playback speeds
- Speed persists across messages
- Tap speed indicator to cycle speeds

---

## Message Editing Improvements

### Edit History

Edited messages now show "(edited)" indicator.

**How it works:**
- Edit message ‚Üí "(edited)" appears next to timestamp
- Click "(edited)" ‚Üí see edit history modal
- History shows all versions + timestamps

**Privacy:**
- Edit history visible to all room members
- Can't hide that you edited
- Original version preserved

**Technical details:**
- New table: `message_edit_history`
- Stores previous versions with timestamps
- Migration: `0067_message_edit_history.sql`

**Why:**
Transparency. Users should know when messages change.

### Edit Time Limit

Messages editable for 15 minutes after sending.

**After 15min:**
- Edit button hidden
- "Can't edit messages older than 15 minutes" toast

**Why:**
Prevents rewriting history in old conversations. 15min is enough to fix typos.

---

## Improved Onboarding

### Welcome Modal for New Users

First-time users see welcome modal with quick-start guide.

**Shows:**
- "Welcome to shapes.inc!"
- 3 quick tips (Create room, Chat with Shapes, Explore directory)
- "Get Started" button

**Dismissible:**
- Click outside or "Get Started" ‚Üí modal closes
- Never shows again (localStorage flag)

### Suggested Shapes to DM

New users see "Suggested Shapes" section with popular Shapes to try.

**Shows 5 shapes:**
- High engagement Shapes
- Diverse use cases (tutor, therapist, coder, creative, assistant)
- Click Shape ‚Üí opens DM

**Where it appears:**
- Empty Shape DMs section (before you've DMed any Shapes)
- Disappears after you start 3+ Shape DMs

**Technical details:**
- Curated list of shape IDs in config
- Fallback to top-rated Shapes if config empty

---

## Forum Improvements

### Pinned Posts

Moderators can pin important posts to top of forum.

**How it works:**
- Post menu (3 dots) ‚Üí "Pin Post" (moderators only)
- Pinned posts show üìå icon
- Always appear at top, sorted by pin date

**Technical details:**
- New column: `forum_posts.is_pinned` (boolean)
- Query: `ORDER BY is_pinned DESC, created_at DESC`
- Moderation permission check

### Post Categories/Tags

Forum posts now support categories.

**Available categories:**
- Announcements
- Feature Requests  
- Bug Reports
- General Discussion
- Questions

**How it works:**
- Create post ‚Üí select category (optional)
- Category badge shows on post card
- Filter posts by category (dropdown in forum header)

**Technical details:**
- New table: `forum_categories`
- `forum_posts.category_id` foreign key
- Documented in `architecture/FORUM_FEATURES.md`

---

## Notification Improvements

### Granular Notification Settings

New notification preferences page with per-type controls.

**Settings:**
- Mentions (@username): on/off
- Direct messages: on/off  
- Room invites: on/off
- Replies to your posts: on/off
- Rewards updates: on/off

**Where:** Settings ‚Üí Notifications ‚Üí toggle each type

**Technical details:**
- New table: `user_notification_preferences`
- Defaults: all enabled
- Migration: `0068_notification_prefs.sql`

### Notification Sound Preferences

Choose notification sound or disable entirely.

**Options:**
- Default (current chime)
- Subtle (quiet beep)  
- None (visual only)

**Saved per-device** (localStorage, not account-wide).

---

## Performance Optimizations

### Message Virtualization

Chat view now renders only visible messages.

**Before:** Render all 1000+ messages in DOM (laggy scrolling)
**After:** Render ~30 visible messages, virtualize rest

**Impact:**
- Smooth scrolling in long chats
- Faster initial load
- Lower memory usage

**Technical details:**
- Uses `@tanstack/react-virtual`
- Dynamic item heights
- Preserves scroll position on new messages

### Image Lazy Loading

Images in chat now lazy-load as you scroll.

**How it works:**
- Images outside viewport: show placeholder
- Scroll near image ‚Üí starts loading
- Loaded images cached

**Impact:**
- Faster page loads
- Reduced bandwidth for users who don't scroll

**Implementation:**
- Native `loading="lazy"` attribute
- IntersectionObserver fallback for unsupported browsers

### Debounced Typing Indicators

Typing indicators now debounced to reduce API spam.

**Before:** Every keystroke ‚Üí API call
**After:** Typing ‚Üí wait 300ms ‚Üí single API call

**Impact:**
- 90% reduction in typing indicator API calls
- Lower server load

---

## Mobile Improvements

### Bottom Navigation for Mobile

Mobile view now has bottom nav bar (iOS/Android style).

**Tabs:**
- üè† Home
- üí¨ Chats  
- üåç Explore (directory)
- üë§ Profile

**Shows when:** Screen width < 768px

**Hides:** Desktop sidebar on mobile (swipe from left edge to open)

**Technical details:**
- Tailwind responsive breakpoints
- Framer Motion slide animations
- Touch gestures for sidebar swipe

### Mobile Composer Improvements

Mobile message composer redesigned for better typing experience.

**Changes:**
- Larger tap targets for buttons
- Auto-resize textarea (grows with content)
- Better keyboard handling (doesn't hide toolbar)
- Voice record button always visible

### Pull-to-Refresh

Swipe down on chat ‚Üí refresh messages.

**Shows:**
- Pull indicator with loading spinner
- "Release to refresh" text
- Haptic feedback (iOS)

**Technical details:**
- Custom pull-to-refresh component
- Detects overscroll at top
- Prevents iOS Safari elastic bounce conflict

---

## Accessibility Improvements

### Keyboard Navigation

Full keyboard navigation support.

**New shortcuts:**
- `Tab` / `Shift+Tab`: Navigate UI elements
- `Enter`: Activate buttons/links
- `Esc`: Close modals
- `‚Üë` / `‚Üì`: Navigate message history in composer
- `Cmd+K` (Mac) / `Ctrl+K` (Windows): Command palette

**Focus indicators:**
- Visible outline on all interactive elements
- Skip-to-content link for screen readers

### Screen Reader Support

Improved ARIA labels and landmarks.

**Changes:**
- Semantic HTML (`<nav>`, `<main>`, `<aside>`)
- ARIA labels on icon buttons
- Live regions for new messages (screen reader announces)
- Alt text required for all images

**Testing:**
- VoiceOver (Mac)
- NVDA (Windows)  
- TalkBack (Android)

### High Contrast Mode

Respects system high contrast settings.

**How it works:**
- Detects `prefers-contrast: high` media query
- Increases color contrast ratios
- Thicker borders on UI elements
- Passes WCAG AAA standards

---

## Bug Fixes

**Fixed Shape Voice Status Not Updating**

Shape voice indicators now update in real-time when Shapes start/stop speaking.

**Fixed Message Link Copying on Mobile**

"Copy Message Link" now works on mobile (was silently failing).

**Fixed Room Join Link Expiration**

Join links now properly expire after 7 days (was never expiring).

**Fixed Profile Picture Upload on iOS**

iOS Safari camera upload now works (HEIC format support added).

**Fixed Emoji Picker Search**

Emoji picker search now finds all relevant emojis (was missing some keywords).

**Fixed Voice Message Recording on Firefox**

Firefox voice recording now works (MediaRecorder compatibility fix).

**Fixed Timezone Display in Message Timestamps**

Timestamps now show in user's local timezone (was always showing UTC).

**Fixed Sidebar Scroll Position Reset**

Sidebar scroll position now preserved when switching chats.

**Fixed Image Upload Progress Bar**

Upload progress bar now shows accurate percentage (was stuck at 0%).

**Fixed Markdown Code Block Rendering**

Multi-line code blocks now preserve formatting and indentation.

---

## API Changes

### Rate Limiting

New rate limits on public APIs.

**Limits:**
- Message send: 10/min per user
- Search: 30/min per user  
- Profile updates: 5/min per user
- General reads: 100/min per user

**Response:**
- `429 Too Many Requests`
- `Retry-After` header with seconds to wait

**Why:** Prevent abuse and ensure fair usage.

### Webhook Support (Beta)

**Coming soon:** Webhooks for room events.

**Planned events:**
- `message.created`
- `member.joined`
- `member.left`

**Use cases:**
- Custom bots
- External integrations  
- Analytics

**Status:** Backend ready, docs coming soon.

---

## Developer Experience

### TypeScript Strict Mode

Enabled TypeScript strict mode across entire codebase.

**Changes:**
- Fixed 400+ type errors
- No more implicit `any`
- Proper null checking
- Better autocomplete in IDEs

**Impact:**
- Fewer runtime errors
- Easier refactoring
- Better code quality

### Component Library Documentation

New Storybook for UI components.

**Where:** `https://storybook.shapes.inc`

**Includes:**
- All reusable components
- Props documentation
- Interactive examples  
- Accessibility notes

**Why:** Easier for developers to find and use existing components.

### API Documentation Updates

Updated API docs with examples and error codes.

**Where:** `https://docs.shapes.inc/api`

**New:**
- Request/response examples for every endpoint
- Error code reference
- Rate limit documentation  
- Authentication guide

---

*Shipped by the team at [shapes.inc](http://shapes.inc). Feedback? Drop it in [Forums](/forums) or DM [@shapes](https://talk.shapes.inc/u/shapes/dm)!*