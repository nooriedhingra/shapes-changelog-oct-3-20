# Shapes.inc Changelog - October 16-20, 2025

## Room Locking

Room owners can now lock rooms to prevent new members from joining.

**How it works:**
- Room settings → "Lock Room" toggle
- Locked rooms block new joins and invites
- Existing members stay in, can still chat
- Only room owner can lock/unlock

**What users see:**
- Join page: "This room is locked" message
- Invite attempts fail with error toast
- Room settings shows lock status

**Use cases:**
- Close friend groups that don't want randoms
- Finished projects that shouldn't get new members
- Private conversations that need to stay private

**Technical details:**
- New `is_locked` column on rooms table
- Migration: `0066_room_locking.sql`
- Enforced at API level (invite/join endpoints)
- Moderation toggle in room settings
- Documented in `architecture/ROOM_LOCKING.md`

---

## Private Rooms (Unlisted from Directory)

Room owners can hide rooms from public directory.

**How it works:**
- Room settings → "Private Room" toggle
- Private rooms don't appear in directory
- Still accessible via direct link or invite
- Members can still find room in their sidebar

**Difference from locked rooms:**
- **Private:** Hidden from directory, can still join via link
- **Locked:** Visible in directory (if public), can't join at all

**Technical details:**
- New `is_private` column on rooms table
- Directory query filters `is_private = false`
- Join page still works for private rooms
- Documented in `architecture/ROOM_PRIVACY.md`

---

## Message Editing

Edit your own messages after sending.

**How it works:**
- Hover message → 3-dot menu → "Edit"
- Edit modal appears with current text
- Make changes → Save
- Message shows "(edited)" badge

**Rules:**
- Can only edit YOUR OWN messages
- Can't edit Shape messages
- Edit history not tracked (shows latest version only)
- Edited badge permanent (can't hide)

**Technical details:**
- New `edited_at` timestamp column
- API: `PATCH /api/messages/[id]`
- Client optimistic update
- Real-time sync via Pusher
- Documented in `architecture/MESSAGE_EDITING.md`

---

## Improved Room Invite Flow

**Share Link Redesign**

Room share UI completely redesigned.

**What changed:**
- New modal design matching shapes.inc style
- Copy link button with toast confirmation
- QR code for easy mobile sharing
- Social share buttons (Twitter, Discord, etc.)

**Technical details:**
- Updated `components/share-room-modal.tsx`
- Uses `react-qrcode` for QR generation
- Clipboard API with fallback

**Invite Members Directly**

New "Invite Members" button in room settings.

**How it works:**
- Room settings → "Invite Members"
- Search users by username/email
- Select multiple users
- Click "Send Invites"
- Users get notification + room appears in sidebar

**Technical details:**
- New API: `POST /api/rooms/[id]/invite`
- Batch invite support (up to 10 users)
- Real-time notification via Pusher
- Prevents duplicate invites

---

## Notification System Overhaul

**In-App Notifications**

New notification center in header.

**What you see:**
- Bell icon with unread count badge
- Click → notification dropdown
- Notifications: mentions, replies, invites, follows
- Mark as read on view
- "Mark all as read" button

**Notification types:**
- **Mention:** Someone @mentioned you
- **Reply:** Someone replied to your message
- **Invite:** You were invited to a room
- **Follow:** Someone followed you
- **DM:** New DM from user

**Technical details:**
- New `notifications` table
- API: `/api/notifications`
- Real-time via Pusher channel
- Client-side unread count cache
- Documented in `architecture/NOTIFICATIONS.md`

**Push Notifications (Web)**

Browser push notifications for important events.

**How it works:**
- Settings → "Enable Notifications"
- Browser prompts permission
- Get push for mentions/DMs when tab closed
- Click notification → opens relevant chat

**Technical details:**
- Uses Web Push API
- Service worker for background delivery
- VAPID keys for security
- Respects browser notification permissions

---

## User Profiles Improvements

**Followers/Following System**

Follow users to see their activity.

**How it works:**
- View profile → "Follow" button
- Following users appear in sidebar
- See their active rooms
- Get notified when they post

**Profile displays:**
- Follower count
- Following count
- Click counts → view lists

**Technical details:**
- New `user_follows` table
- API: `/api/users/[id]/follow`
- Bi-directional relationship
- Documented in `architecture/USER_FOLLOWS.md`

**Bio and Social Links**

Users can now add:
- Bio (280 char limit)
- Twitter handle
- Discord username
- GitHub username
- Website URL

**Where it shows:**
- Profile modal
- User directory
- Hover card (quick preview)

**Technical details:**
- New columns on users table
- Migration: `0067_user_profile_fields.sql`
- Validation: URL format, handle format
- XSS protection on bio content

---

## Homepage Redesign

**New Landing Page**

Completely redesigned homepage for logged-out users.

**What's new:**
- Hero section with demo video
- Feature showcase grid
- Testimonials from users
- Clear CTA: "Start Chatting"
- Mobile-optimized layout

**Why:**
Old homepage didn't explain what shapes.inc does. New design shows product in action.

**Technical details:**
- New route: `app/(marketing)/page.tsx`
- Tailwind CSS animations
- Optimized images (WebP format)
- Lighthouse score: 95+

**Logged-In Homepage Changes**

Updated chat dashboard for logged-in users.

**What changed:**
- Recent rooms at top (sorted by your last message)
- Trending rooms section (high activity)
- Suggested rooms based on your interests
- Quick actions: Create Room, Find Friends

**Technical details:**
- Server-side room sorting
- Cached trending calculation
- Personalized recommendations

---

## Search Improvements

**Global Search (Cmd+K Enhancements)**

**New search categories:**
- Users (search by username/display name)
- Messages (search across all your rooms)
- Forums (search forum posts)

**Before:** Only searched rooms and DMs.
**After:** Search everything in one place.

**Performance improvements:**
- Debounced search (300ms delay)
- Cached results for repeat queries
- Parallel API calls for each category

**Better result display:**
- Icons for each result type
- Preview text for messages/posts
- Keyboard navigation (arrow keys)
- Recent searches saved

**Technical details:**
- Updated `components/command-palette.tsx`
- New APIs: `/api/search/users`, `/api/search/messages`
- Documented in `architecture/COMMAND_PALETTE.md`

---

## Sidebar UX Improvements

**Collapsible Sections**

Sidebar sections now collapse/expand.

**How it works:**
- Click section header → collapses
- State persists in localStorage
- Collapsed sections show count badge

**Sections:**
- Direct Messages
- Rooms
- Shape Communities
- Custom Categories

**Why:**
Long room lists made sidebar overwhelming. Now collapse sections you don't use often.

**Drag-and-Drop Reordering**

Reorder rooms in sidebar by dragging.

**How it works:**
- Hover room → drag handle appears
- Drag to new position
- Order saves automatically
- Syncs across devices

**Technical details:**
- Uses `@dnd-kit/core`
- Optimistic UI updates
- API: `POST /api/users/sidebar-order`
- Stored in user preferences table

**Custom Categories**

Create custom sidebar sections.

**How it works:**
- Sidebar → "Add Category" button
- Name your category
- Drag rooms into it
- Rename/delete anytime

**Use cases:**
- "Work" vs "Personal" rooms
- "Active Projects" vs "Archive"
- "Friends" vs "Public Communities"

**Technical details:**
- New `user_sidebar_categories` table
- Migration: `0068_sidebar_categories.sql`
- JSON array stores room IDs per category
- Documented in `architecture/SIDEBAR_CUSTOMIZATION.md`

---

## Message Features

**Reactions**

React to messages with emoji.

**How it works:**
- Hover message → emoji picker icon
- Click emoji → adds reaction
- Click your reaction → removes it
- Multiple users can use same emoji

**Display:**
- Reactions appear below message
- Shows emoji + count
- Hover → see who reacted
- Max 6 unique emojis per message

**Technical details:**
- New `message_reactions` table
- API: `/api/messages/[id]/reactions`
- Real-time sync via Pusher
- Optimistic UI updates
- Documented in `architecture/MESSAGE_REACTIONS.md`

**Message Threads (Coming Soon)**

Foundation work for threaded replies.

**What shipped:**
- Database schema for threads
- API endpoints (not exposed yet)
- UI components (hidden behind feature flag)

**When it launches:**
Users will be able to reply to specific messages, creating organized threads within chat.

**Status:** Backend complete, frontend in progress.

---

## Performance Improvements

**Lazy Load Sidebar Rooms**

Sidebar now loads rooms incrementally.

**Before:** Load all rooms on page load (slow for users in 100+ rooms).
**After:** Load first 20 rooms, lazy-load rest as you scroll.

**Impact:**
- 60% faster initial page load
- Reduced memory usage
- Smoother scrolling

**Technical details:**
- Virtualized list with `react-window`
- Intersection Observer for scroll detection
- Background prefetch for smooth UX

**Message List Virtualization**

Chat message list now virtualized.

**Before:** Render all messages in DOM (laggy with 1000+ messages).
**After:** Only render visible messages + buffer.

**Impact:**
- Smooth scrolling in long chats
- Lower memory footprint
- Faster initial render

**Technical details:**
- Custom virtualization (not react-window)
- Dynamic height calculation
- Maintains scroll position on new messages
- Documented in `architecture/MESSAGE_LIST_VIRTUALIZATION.md`

**Image Optimization**

All images now served through CDN with optimization.

**What changed:**
- Profile pictures: WebP format, multiple sizes
- Room covers: Responsive images
- Message attachments: Lazy-loaded

**Impact:**
- 40% smaller image payload
- Faster page loads
- Better mobile experience

**Technical details:**
- Cloudflare Images for CDN
- Next.js Image component
- Automatic format detection (WebP/AVIF)

---

## Mobile App (PWA)

**Install as App**

Shapes.inc now works as installable PWA.

**How it works:**
- Visit shapes.inc on mobile
- Browser prompts "Add to Home Screen"
- Icon appears on home screen
- Opens in standalone mode (no browser UI)

**PWA features:**
- Offline support (view cached messages)
- Push notifications
- Background sync
- Native-like experience

**Technical details:**
- Service worker with offline cache
- Web manifest with app metadata
- Custom install prompt
- Documented in `architecture/PWA.md`

---

## Moderation Tools

**Message Reports**

Users can now report inappropriate messages.

**How it works:**
- Message menu → "Report"
- Select reason (spam, harassment, etc.)
- Optional description
- Submit → goes to moderation queue

**Moderator view:**
- New "Reports" tab in moderation panel
- See reported message + context
- Actions: Delete message, warn user, ban user, dismiss

**Technical details:**
- New `message_reports` table
- API: `/api/moderation/reports`
- Email notification to moderators
- Documented in `architecture/MODERATION_AND_BANS.md`

**Auto-Moderation (Spam Filter)**

Basic auto-moderation for obvious spam.

**What it catches:**
- Messages with 5+ links
- Repeated messages (same text 3+ times)
- Known spam patterns

**Actions:**
- Flags for review (doesn't auto-delete)
- Rate-limits user temporarily
- Notifies moderators

**Technical details:**
- Server-side message scanning
- Pattern matching + heuristics
- No AI/ML (rule-based only)

---

## Bug Fixes

**Fixed Message Order in Fast-Moving Chats**

Messages occasionally appeared out of order in high-traffic rooms. Fixed timestamp comparison logic.

**Fixed Sidebar Scroll Position Reset**

Sidebar would scroll to top on new message. Now preserves scroll position.

**Fixed Emoji Picker Z-Index**

Emoji picker was appearing behind modals. Fixed stacking context.

**Fixed Mobile Keyboard Overlap**

Composer textarea was hidden behind mobile keyboard. Added viewport height calculation.

**Fixed Profile Picture Upload**

Large images (>5MB) were timing out. Added client-side compression before upload.

**Fixed Room Directory Pagination**

Directory "Load More" button wasn't working. Fixed API cursor logic.

**Fixed DM Notification Badge**

Unread DM count wasn't updating in real-time. Fixed Pusher event handling.

**Fixed Search Highlighting**

Search results weren't highlighting matched text. Added proper mark.js integration.

---

## API Changes

**Rate Limiting**

Implemented rate limits on all public APIs.

**Limits:**
- Messages: 60/minute
- Room creation: 5/hour
- Profile updates: 10/minute
- Search: 30/minute

**Response:**
- 429 status code
- `Retry-After` header
- Error toast for users

**Technical details:**
- Redis-backed rate limiter
- Per-user + per-IP tracking
- Documented in `architecture/RATE_LIMITING.md`

**Webhook Support**

New webhooks for external integrations.

**Available events:**
- `message.created`
- `room.created`
- `user.joined`
- `user.banned`

**Use cases:**
- Discord/Slack bots
- Analytics tracking
- Custom automation

**Technical details:**
- Configure in room settings (owners only)
- HMAC signature verification
- Retry logic for failed deliveries
- Documented in `architecture/WEBHOOKS.md`

---

*Shipped by the team at [shapes.inc](http://shapes.inc). Feedback? Drop it in [Forums](/forums)!*